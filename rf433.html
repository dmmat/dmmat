<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 RF433 BLE Bridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Підключення Bootstrap 5 (CDN) для стилів -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      margin: 20px;
      background: #f8f9fa;
    }
    .code-entry {
      border-left: 4px solid #0d6efd;
      padding-left: 10px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="my-4 text-primary">ESP32 RF433 BLE Bridge</h1>

  <!-- Підключення до BLE -->
  <div class="card p-3 mb-4">
    <div class="d-flex align-items-center">
      <button id="connectBtn" class="btn btn-primary me-2">Підключитися</button>
      <button id="disconnectBtn" class="btn btn-secondary me-3" disabled>Відключитися</button>
      <span id="status" class="text-muted">Немає з’єднання</span>
    </div>
  </div>

  <!-- Налаштування RCSwitch -->
  <div class="card p-3 mb-4">
    <h4>Налаштування RCSwitch</h4>
    <p class="text-muted">Протокол, тривалість імпульсу, толерантність та кількість повторів.</p>
    <div class="row g-2 mb-3">
      <div class="col">
        <label class="form-label">Protocol</label>
        <input type="number" class="form-control" id="protocolInput" value="1" />
      </div>
      <div class="col">
        <label class="form-label">Pulse (μs)</label>
        <input type="number" class="form-control" id="pulseInput" value="350" />
      </div>
      <div class="col">
        <label class="form-label">Tolerance</label>
        <input type="number" class="form-control" id="toleranceInput" value="60" />
      </div>
      <div class="col">
        <label class="form-label">Repeat</label>
        <input type="number" class="form-control" id="repeatInput" value="4" />
      </div>
    </div>
    <div>
      <button id="readConfigBtn" class="btn btn-outline-primary me-2">Зчитати</button>
      <button id="applyConfigBtn" class="btn btn-success">Застосувати</button>
    </div>
  </div>

  <!-- Відправка 433 коду -->
  <div class="card p-3 mb-4">
    <h4>Відправити код 433 МГц</h4>
    <p class="text-muted">Можна також зберегти введений код у LocalStorage.</p>
    <div class="row g-2 mb-3">
      <div class="col">
        <label class="form-label">Код</label>
        <input type="text" class="form-control" id="rfCodeInput" placeholder="Напр. 123456" />
      </div>
      <div class="col">
        <label class="form-label">Бітна довжина</label>
        <input type="number" class="form-control" id="bitLengthInput" value="24" />
      </div>
    </div>
    <div>
      <button id="sendCodeBtn" class="btn btn-primary me-2">Відправити</button>
      <button id="saveCodeBtn" class="btn btn-outline-secondary">Зберегти код</button>
    </div>
  </div>

  <!-- Отримані / збережені коди -->
  <div class="card p-3 mb-4">
    <h4>Отримані коди (LocalStorage)</h4>
    <p class="text-muted" style="font-size: 0.9rem;">
      Унікальні коди зберігаються з датою. Якщо код повторюється, дата оновлюється і код іде на початок списку.
    </p>
    <div id="receivedCodes" class="mt-2"></div>
  </div>
</div>

<!-- Bootstrap 5 JS -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
></script>

<script>
  // --------------------------
  // BLE UUID (з main.cpp)
  // --------------------------
  const SERVICE_UUID        = "8e410001-f315-4f60-9fb8-838830daea50";
  const CHARACTERISTIC_CFG  = "8e402002-f315-4f60-9fb8-838830daea50";
  const CHARACTERISTIC_CODE = "8e430003-f315-4f60-9fb8-838830daea50";

  let bleDevice            = null;
  let bleServer            = null;
  let cfgCharacteristic    = null;
  let codeCharacteristic   = null;

  // Елементи керування
  const connectBtn         = document.getElementById("connectBtn");
  const disconnectBtn      = document.getElementById("disconnectBtn");
  const statusElem         = document.getElementById("status");

  const readConfigBtn      = document.getElementById("readConfigBtn");
  const applyConfigBtn     = document.getElementById("applyConfigBtn");
  const protocolInput      = document.getElementById("protocolInput");
  const pulseInput         = document.getElementById("pulseInput");
  const toleranceInput     = document.getElementById("toleranceInput");
  const repeatInput        = document.getElementById("repeatInput");

  const rfCodeInput        = document.getElementById("rfCodeInput");
  const bitLengthInput     = document.getElementById("bitLengthInput");
  const sendCodeBtn        = document.getElementById("sendCodeBtn");
  const saveCodeBtn        = document.getElementById("saveCodeBtn");

  const receivedCodesElem  = document.getElementById("receivedCodes");

  // --------------------------
  // Кнопка "Підключитися"
  // --------------------------
  connectBtn.addEventListener("click", async () => {
    try {
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }]
      });
      bleDevice.addEventListener("gattserverdisconnected", onDisconnected);

      statusElem.textContent = "З’єднуємо...";
      bleServer = await bleDevice.gatt.connect();

      const service = await bleServer.getPrimaryService(SERVICE_UUID);

      // Характеристика для налаштувань
      cfgCharacteristic = await service.getCharacteristic(CHARACTERISTIC_CFG);
      await cfgCharacteristic.startNotifications();
      cfgCharacteristic.addEventListener("characteristicvaluechanged", onConfigNotify);

      // Характеристика для кодів
      codeCharacteristic = await service.getCharacteristic(CHARACTERISTIC_CODE);
      await codeCharacteristic.startNotifications();
      codeCharacteristic.addEventListener("characteristicvaluechanged", onCodeNotify);

      statusElem.textContent = "Підключено";
      connectBtn.disabled = true;
      disconnectBtn.disabled = false;
      console.log("[BLE] Підключення успішне.");
    } catch (error) {
      console.error(error);
      statusElem.textContent = "Помилка підключення: " + error;
    }
  });

  // --------------------------
  // Кнопка "Відключитися"
  // --------------------------
  disconnectBtn.addEventListener("click", () => {
    if (bleDevice && bleDevice.gatt.connected) {
      console.log("[BLE] Відключення...");
      bleDevice.gatt.disconnect();
    }
  });

  function onDisconnected() {
    console.log("[BLE] Роз'єднано.");
    statusElem.textContent = "Немає з’єднання";
    connectBtn.disabled = false;
    disconnectBtn.disabled = true;
  }

  // --------------------------
  // NOTIFY: зміна Config
  // --------------------------
  function onConfigNotify(event) {
    const decoder = new TextDecoder("utf-8");
    const str = decoder.decode(event.target.value);
    console.log("[BLE:CFG] Notification:", str);
    // За замовчуванням ми не обробляємо ніяк,
    // оскільки основний сенс — читати/писати через Read/Write.
  }

  // --------------------------
  // NOTIFY: отриманий 433-код
  // (формат "код,біт")
  // --------------------------
  function onCodeNotify(event) {
    const decoder = new TextDecoder("utf-8");
    const str = decoder.decode(event.target.value);
    console.log("[BLE:CODE] Отримано:", str);

    const parts = str.split(",");
    if (parts.length < 2) return;
    const code = parts[0];
    const bitLen = parts[1];

    // Зберігаємо код з датою
    saveReceivedCode(code, bitLen);
  }

  // --------------------------
  // Зчитати конфіг (Read)
  // --------------------------
  readConfigBtn.addEventListener("click", async () => {
    if (!cfgCharacteristic) {
      alert("Немає з’єднання з BLE!");
      return;
    }
    try {
      const val = await cfgCharacteristic.readValue();
      const decoder = new TextDecoder("utf-8");
      const str = decoder.decode(val);
      console.log("[BLE:CFG] ReadValue:", str);

      const obj = JSON.parse(str);
      protocolInput.value   = obj.protocol;
      pulseInput.value      = obj.pulse;
      toleranceInput.value  = obj.tolerance;
      repeatInput.value     = obj.repeat;

      alert("Налаштування зчитано успішно!");
    } catch (error) {
      console.error(error);
      alert("Помилка зчитування налаштувань!");
    }
  });

  // --------------------------
  // Застосувати конфіг (Write)
  // --------------------------
  applyConfigBtn.addEventListener("click", async () => {
    if (!cfgCharacteristic) {
      alert("Немає з’єднання з BLE!");
      return;
    }
    const obj = {
      protocol: parseInt(protocolInput.value, 10),
      pulse: parseInt(pulseInput.value, 10),
      tolerance: parseInt(toleranceInput.value, 10),
      repeat: parseInt(repeatInput.value, 10),
    };
    const str = JSON.stringify(obj);
    console.log("[BLE:CFG] Записуємо:", str);

    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      await cfgCharacteristic.writeValue(data);
      alert("Налаштування застосовано!");
    } catch (error) {
      console.error(error);
      alert("Помилка запису налаштувань!");
    }
  });

  // --------------------------
  // Відправити код "код,біт"
  // --------------------------
  sendCodeBtn.addEventListener("click", async () => {
    if (!codeCharacteristic) {
      alert("Немає з’єднання з BLE!");
      return;
    }
    const codeStr = rfCodeInput.value.trim();
    const bitLen = bitLengthInput.value.trim();
    if (!codeStr || !bitLen) {
      alert("Будь ласка, введіть код і бітну довжину!");
      return;
    }
    const msg = codeStr + "," + bitLen;
    console.log("[BLE:CODE] Відправляємо:", msg);
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(msg);
      await codeCharacteristic.writeValueWithoutResponse(data);
    } catch (error) {
      console.error(error);
      alert("Помилка відправки коду!");
    }
  });

  // --------------------------
  // Кнопка "Зберегти код" (вручну)
  // --------------------------
  saveCodeBtn.addEventListener("click", () => {
    const codeStr = rfCodeInput.value.trim();
    const bitLen = bitLengthInput.value.trim();
    if (!codeStr || !bitLen) {
      alert("Будь ласка, введіть код і бітну довжину!");
      return;
    }
    saveReceivedCode(codeStr, bitLen);
    alert("Код збережено у LocalStorage!");
  });

  // --------------------------
  // Збереження отриманих/введених кодів у LocalStorage
  // --------------------------
  const STORAGE_KEY = "receivedRfCodes";

  document.addEventListener("DOMContentLoaded", () => {
    loadAndDisplayReceivedCodes();
  });

  // Зберігаємо унікальний код із датою. Якщо код уже існує — оновлюємо дату і ставимо код нагорі.
  function saveReceivedCode(code, bitLen) {
    let codes = loadCodes();
    let now = new Date().toISOString();

    // Шукаємо чи існує
    let existingIndex = codes.findIndex(item => item.code === code && item.bitLen === bitLen);
    if (existingIndex >= 0) {
      // Оновлюємо дату та переносимо нагору
      codes[existingIndex].date = now;
      let [found] = codes.splice(existingIndex, 1);
      codes.unshift(found);
    } else {
      // Додаємо новий
      codes.unshift({ code, bitLen, date: now });
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(codes));
    displayReceivedCodes(codes);
  }

  function loadAndDisplayReceivedCodes() {
    let codes = loadCodes();
    displayReceivedCodes(codes);
  }

  function loadCodes() {
    try {
      let stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch (error) {
      console.warn("[LocalStorage] Помилка:", error);
      return [];
    }
  }

  // Відмалювати список кодів
  function displayReceivedCodes(codes) {
    receivedCodesElem.innerHTML = "";
    if (codes.length === 0) {
      receivedCodesElem.innerHTML = '<p class="text-muted">Немає збережених кодів</p>';
      return;
    }
    codes.forEach(item => {
      const div = document.createElement("div");
      div.className = "code-entry";
      const timeStr = new Date(item.date).toLocaleString("uk-UA");
      div.innerHTML = `
        <strong>Код:</strong> ${item.code}, 
        <strong>Біт:</strong> ${item.bitLen}<br/>
        <small class="text-muted">Останнє збереження: ${timeStr}</small>
      `;
      receivedCodesElem.appendChild(div);
    });
  }
</script>
</body>
</html>
