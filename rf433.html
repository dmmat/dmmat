<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 RF433 BLE Bridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap (CDN) для швидкого оформлення -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      margin: 20px;
      background: #f8f9fa;
    }
    .code-entry {
      border-left: 4px solid #0d6efd;
      padding-left: 10px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="my-4 text-primary">ESP32 RF433 BLE Bridge</h1>

  <!-- Підключення до BLE -->
  <div class="card p-3 mb-4">
    <div class="d-flex align-items-center">
      <button id="connectBtn" class="btn btn-primary me-2">Connect</button>
      <button id="disconnectBtn" class="btn btn-secondary me-3" disabled>Disconnect</button>
      <span id="status" class="text-muted">Disconnected</span>
    </div>
  </div>

  <!-- Налаштування RCSwitch -->
  <div class="card p-3 mb-4">
    <h4>Налаштування RCSwitch</h4>
    <div class="row g-2 mb-3">
      <div class="col">
        <label class="form-label">Protocol</label>
        <input type="number" class="form-control" id="protocolInput" value="1" />
      </div>
      <div class="col">
        <label class="form-label">Pulse (μs)</label>
        <input type="number" class="form-control" id="pulseInput" value="350" />
      </div>
      <div class="col">
        <label class="form-label">Tolerance</label>
        <input type="number" class="form-control" id="toleranceInput" value="60" />
      </div>
      <div class="col">
        <label class="form-label">Repeat</label>
        <input type="number" class="form-control" id="repeatInput" value="4" />
      </div>
    </div>
    <div>
      <button id="readConfigBtn" class="btn btn-outline-primary me-2">Прочитати</button>
      <button id="applyConfigBtn" class="btn btn-success">Застосувати</button>
    </div>
  </div>

  <!-- Відправка 433 коду -->
  <div class="card p-3 mb-4">
    <h4>Надіслати код 433 МГц</h4>
    <div class="row g-2 mb-3">
      <div class="col">
        <label class="form-label">Код</label>
        <input type="text" class="form-control" id="rfCodeInput" placeholder="Напр. 123456" />
      </div>
      <div class="col">
        <label class="form-label">Бітна довжина</label>
        <input type="number" class="form-control" id="bitLengthInput" value="24" />
      </div>
    </div>
    <button id="sendCodeBtn" class="btn btn-primary">Send</button>
  </div>

  <!-- Отримані коди -->
  <div class="card p-3 mb-4">
    <h4>Отримані коди (localStorage)</h4>
    <p class="text-muted" style="font-size: 0.9rem;">
      Унікальні коди зберігаються в localStorage із датою. Якщо код уже існує,
      оновлюємо дату й переміщуємо код у початок списку.
    </p>
    <div id="receivedCodes"></div>
  </div>
</div>

<!-- Bootstrap JS -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
></script>

<script>
  // --------------------------
  // UUID із коду ESP32
  // --------------------------
  const SERVICE_UUID        = "8e410001-f315-4f60-9fb8-838830daea50";
  const CHARACTERISTIC_CFG  = "8e402002-f315-4f60-9fb8-838830daea50";
  const CHARACTERISTIC_CODE = "8e430003-f315-4f60-9fb8-838830daea50";

  let bleDevice = null;
  let bleServer = null;
  let cfgCharacteristic = null;
  let codeCharacteristic = null;

  // Елементи управління
  const connectBtn      = document.getElementById("connectBtn");
  const disconnectBtn   = document.getElementById("disconnectBtn");
  const statusElem      = document.getElementById("status");

  const readConfigBtn   = document.getElementById("readConfigBtn");
  const applyConfigBtn  = document.getElementById("applyConfigBtn");
  const protocolInput   = document.getElementById("protocolInput");
  const pulseInput      = document.getElementById("pulseInput");
  const toleranceInput  = document.getElementById("toleranceInput");
  const repeatInput     = document.getElementById("repeatInput");

  const rfCodeInput     = document.getElementById("rfCodeInput");
  const bitLengthInput  = document.getElementById("bitLengthInput");
  const sendCodeBtn     = document.getElementById("sendCodeBtn");

  const receivedCodesElem = document.getElementById("receivedCodes");

  // --------------------------
  // КНОПКА CONNECT
  // --------------------------
  connectBtn.addEventListener("click", async () => {
    try {
      // Запит на вибір BLE пристрою, що рекламує наш SERVICE_UUID
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }]
      });

      bleDevice.addEventListener("gattserverdisconnected", onDisconnected);

      statusElem.textContent = "Connecting...";
      // Підключення GATT
      const server = await bleDevice.gatt.connect();
      bleServer = server;

      // Отримуємо сервіс
      const service = await bleServer.getPrimaryService(SERVICE_UUID);

      // Характеристика налаштувань
      cfgCharacteristic = await service.getCharacteristic(CHARACTERISTIC_CFG);
      await cfgCharacteristic.startNotifications();
      cfgCharacteristic.addEventListener("characteristicvaluechanged", onConfigNotify);

      // Характеристика кодів
      codeCharacteristic = await service.getCharacteristic(CHARACTERISTIC_CODE);
      await codeCharacteristic.startNotifications();
      codeCharacteristic.addEventListener("characteristicvaluechanged", onCodeNotify);

      statusElem.textContent = "Connected";
      disconnectBtn.disabled = false;
      connectBtn.disabled = true;
      console.log("[BLE] Підключилися.");
    } catch (error) {
      console.error(error);
      statusElem.textContent = "Connection failed: " + error;
    }
  });

  // --------------------------
  // КНОПКА DISCONNECT
  // --------------------------
  disconnectBtn.addEventListener("click", () => {
    if (!bleDevice) return;
    if (bleDevice.gatt.connected) {
      console.log("[BLE] Від'єднання...");
      bleDevice.gatt.disconnect();
    }
  });

  function onDisconnected() {
    console.log("[BLE] Роз'єднано.");
    statusElem.textContent = "Disconnected";
    connectBtn.disabled = false;
    disconnectBtn.disabled = true;
  }

  // --------------------------
  // NOTIFY: отримання змін CFG
  // (у цьому прикладі ми нечасто їх шлемо,
  // але startNotifications під’єднано про всяк випадок)
  // --------------------------
  function onConfigNotify(event) {
    const value = event.target.value;
    const decoder = new TextDecoder("utf-8");
    const str = decoder.decode(value);
    console.log("[BLE:CFG] Notification:", str);
  }

  // --------------------------
  // NOTIFY: отримання кодів
  // --------------------------
  function onCodeNotify(event) {
    const value = event.target.value;
    const decoder = new TextDecoder("utf-8");
    const str = decoder.decode(value); // Формат: "код,біт"

    console.log("[BLE:CODE] Notification:", str);
    const parts = str.split(",");
    if (parts.length < 2) return;
    const codeNum = parts[0];
    const bitLen = parts[1];

    saveReceivedCode(codeNum, bitLen);
  }

  // --------------------------
  // Зчитати (READ) Config
  // --------------------------
  readConfigBtn.addEventListener("click", async () => {
    try {
      if (!cfgCharacteristic) {
        alert("Не підключено до BLE :(");
        return;
      }
      // Викликаємо readValue() і парсимо JSON
      const val = await cfgCharacteristic.readValue();
      const decoder = new TextDecoder("utf-8");
      const str = decoder.decode(val);
      console.log("[BLE:CFG] Read:", str);

      const obj = JSON.parse(str); // {"protocol":1,"pulse":350,"tolerance":60,"repeat":4}
      protocolInput.value = obj.protocol;
      pulseInput.value = obj.pulse;
      toleranceInput.value = obj.tolerance;
      repeatInput.value = obj.repeat;

      alert("Налаштування зчитано успішно!");
    } catch (error) {
      console.error(error);
    }
  });

  // --------------------------
  // Записати (WRITE) Config
  // --------------------------
  applyConfigBtn.addEventListener("click", async () => {
    try {
      if (!cfgCharacteristic) {
        alert("Не підключено до BLE :(");
        return;
      }
      // Формуємо JSON
      const obj = {
        protocol: parseInt(protocolInput.value, 10),
        pulse: parseInt(pulseInput.value, 10),
        tolerance: parseInt(toleranceInput.value, 10),
        repeat: parseInt(repeatInput.value, 10)
      };
      const str = JSON.stringify(obj); 
      const encoder = new TextEncoder();
      const data = encoder.encode(str);

      await cfgCharacteristic.writeValue(data);
      alert("Налаштування застосовано!");
    } catch (error) {
      console.error(error);
    }
  });

  // --------------------------
  // Надсилання коду (Write до CODE) 
  // Формат: "код,біт"
  // --------------------------
  sendCodeBtn.addEventListener("click", async () => {
    if (!codeCharacteristic) {
      alert("Не підключено до BLE :(");
      return;
    }
    const codeStr = rfCodeInput.value.trim();
    const bitLen = bitLengthInput.value.trim();
    if (!codeStr || !bitLen) {
      alert("Введіть код і бітну довжину!");
      return;
    }
    const msg = codeStr + "," + bitLen;
    const encoder = new TextEncoder();
    const data = encoder.encode(msg);
    try {
      await codeCharacteristic.writeValueWithoutResponse(data);
      console.log("[BLE:CODE] Sent:", msg);
    } catch (error) {
      console.error("[BLE:CODE] Error:", error);
    }
  });

  // --------------------------
  // Збереження унікальних кодів із датою в localStorage
  // --------------------------
  const STORAGE_KEY = "receivedRfCodes";

  // Відображення при завантаженні сторінки
  document.addEventListener("DOMContentLoaded", () => {
    loadAndDisplayReceivedCodes();
  });

  function saveReceivedCode(code, bitLen) {
    let codes = loadCodes();
    // Шукаємо, чи вже є такий код
    let existing = codes.findIndex(item => item.code === code && item.bitLen == bitLen);
    let now = new Date().toISOString(); // або інший формат
    if (existing >= 0) {
      // Оновлюємо дату і переміщаємо вверх
      codes[existing].date = now;
      const [found] = codes.splice(existing, 1);
      codes.unshift(found);
    } else {
      // Додаємо новий
      codes.unshift({ code, bitLen, date: now });
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(codes));
    displayReceivedCodes(codes);
  }

  function loadAndDisplayReceivedCodes() {
    let codes = loadCodes();
    displayReceivedCodes(codes);
  }

  function loadCodes() {
    try {
      let stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.warn("Проблема з localStorage:", e);
      return [];
    }
  }

  function displayReceivedCodes(codes) {
    receivedCodesElem.innerHTML = "";
    if (codes.length === 0) {
      receivedCodesElem.innerHTML = '<p class="text-muted">Немає збережених кодів</p>';
      return;
    }
    codes.forEach(item => {
      const div = document.createElement("div");
      div.className = "code-entry";
      const timeStr = new Date(item.date).toLocaleString("uk-UA"); 
      div.innerHTML = `
        <strong>Код:</strong> ${item.code}, 
        <strong>Біт:</strong> ${item.bitLen} <br/>
        <small class="text-muted">Останнє отримання: ${timeStr}</small>
      `;
      receivedCodesElem.appendChild(div);
    });
  }
</script>

</body>
</html>
